{% extends "base/base.html" %}
{% load static %}

{% block content %}
<div class="page-content">
    <div class="container-fluid">

        <div class="row">

            <div class="col-xl-8">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Profile</h4>

                        {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            {% endfor %}
                        {% endif %}

                        <div class="row">
                            <div class="col-lg-4">
                                <div class="border p-3 rounded mt-4">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="avatar-xs me-3">
                                            <span class="avatar-title rounded-circle bg-warning-subtle text-warning font-size-18">
                                                <i class="mdi mdi-briefcase"></i>
                                            </span>
                                        </div>
                                        <h5 class="font-size-14 mb-0">Leave</h5>
                                    </div>

                                    <div class="col-lg-6 py-2">
                                            <a href="javascript: void(0);" class="btn btn-primary">Apply</a>              
                                    </div>
                                    
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="border p-3 rounded mt-4">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="avatar-xs me-3">
                                            <span class="avatar-title rounded-circle bg-warning-subtle text-warning font-size-18">
                                                <i class="mdi mdi-cash"></i>
                                            </span>
                                        </div>
                                        <h5 class="font-size-14 mb-0">Salary Advance</h5>
                                    </div>

                    

                                    <div class="col-lg-6 py-2">

                                            <a href="javascript: void(0);" class="btn btn-primary">Apply</a>
                
                                    </div>
                                    
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="border p-3 rounded mt-4">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="avatar-xs me-3">
                                            <span class="avatar-title rounded-circle bg-warning-subtle text-warning font-size-18">
                                                <i class="mdi mdi-calendar-remove"></i>
                                            </span>
                                        </div>
                                        <h5 class="font-size-14 mb-0">Leave Commutation</h5>
                                    </div>

                    

                                    <div class="col-lg-6 py-2">

                                            <a href="javascript: void(0);" class="btn btn-primary">Apply</a>
                
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <div class="row">
                    <div class="col-xl-6">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title mb-4">Leave</h4>
                                
                                <div id="pie_chart" data-colors='["--bs-success","--bs-primary", "--bs-danger","--bs-info", "--bs-warning"]' class="apex-charts" dir="ltr"></div>
                            </div>
                        </div>
                    </div>
                    <!-- end col -->
                    
                    <div class="col-xl-6">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title mb-4">Salary Advance</h4>
                                
                                <div id="donut_chart" data-colors='["--bs-success","--bs-primary", "--bs-danger","--bs-info", "--bs-warning"]' class="apex-charts"  dir="ltr"></div>
                            </div>
                        </div>
                    </div>
                    <!-- end col -->
                </div>
            </div>

            <div class="col-xl-4">
                <div class="card">
                    <div class="card-body border-bottom">
                        <div class="float-end dropdown ms-2">
                            <a class="text-muted" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="mdi mdi-dots-horizontal font-size-18"></i>
                            </a>
                          
                            <div class="dropdown-menu dropdown-menu-end">
                              <a class="dropdown-item" href="#">Action</a>
                              <a class="dropdown-item" href="#">Another action</a>
                              <a class="dropdown-item" href="#">Something else here</a>
                            </div>
                        </div>
                        
                        <div>
                            <div class="mb-4 me-3">
                                <i class="mdi mdi-account-circle text-primary h1"></i>
                            </div>

                            <div>
                                <h5 class="">{{ get_employee.first_name }} {{ get_employee.last_name }}</h5>
                                <p class="text-muted mb-1">{{ get_employee.email }}</p>
                                <p class="text-muted mb-0">Employee no: {{ get_employee.employee_id }}</p>
                                <p class="text-muted mb-0">Id no: {{ get_employee.identification_number }}</p>
                                
                            </div>
                        </div>
                    </div>
                    <div class="card-body border-bottom">
                        <div>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div>
                                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModalScrollable">
                                            Update Profile

                                        </button>
                                    </div>
                                </div>

                                <div class="col-sm-6">
                                    <div>
                                        <button type="button" class="btn btn-primary waves-effect waves-light" data-bs-toggle="modal" data-bs-target="#SettingsModalScrollable">
                                            Settings
                                        </button>
                                    </div>
                                </div>
                               
                            </div>
                        </div>
                        
                    </div>

                </div>

                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Personal Information</h4>

                        <div>
                            <ul class="verti-timeline list-unstyled">
                                <li class="event-list">
                                    <div class="event-timeline-dot">
                                        <i class="bx bx-right-arrow-circle"></i>
                                    </div>
                                    <div class="d-flex">
                                        <div class="flex-shrink-0 me-3">
                                            <i class="bx bx-user-plus h2 text-primary"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div>
                                                <h5 class="font-size-14">Username</h5>
                                                <p class="text-muted">{{ request.user.username }}</p>
                                            </div>

                            

                                            <div>
                                                <h5 class="font-size-14">Address</h5>
                                                <p class="text-muted">{{ request.user.employee.address }}</p>
                                            </div>

                                            
                                            <div>
                                                <h5 class="font-size-14">Position</h5>
                                                <p class="text-muted">{{ request.user.employee.postion  }}</p>
                                            </div>

                                            <div>
                                                <h5 class="font-size-14">Department</h5>
                                                <p class="text-muted">{{ request.user.employee.department |upper }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </li>
            
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- end row -->
        
    </div> <!-- container-fluid  0763409727-->
</div>

<!-- Update Profile Modal -->
<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-body">
                <!-- Scrollable Modal -->
                <div class="modal fade" id="exampleModalScrollable" tabindex="-1" role="dialog"
                    aria-labelledby="exampleModalScrollableTitle" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalScrollableTitle">
                                    {{ get_employee.first_name }} {{ get_employee.last_name }} - Profile
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form method="POST" action="{% url 'base:update_profile' %}" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label>First Name</label>
                                        <input type="text" name="first_name" class="form-control" value="{{ get_employee.first_name }}">
                                    </div>
                                    <div class="mb-3">
                                        <label>Last Name</label>
                                        <input type="text" name="last_name" class="form-control" value="{{ get_employee.last_name }}">
                                    </div>
                                    <div class="mb-3">
                                        <label>Email</label>
                                        <input type="email" name="email" class="form-control" value="{{ get_employee.email }}">
                                    </div>
                                    <div class="mb-3">
                                        <label>Address</label>
                                        <input type="text" name="address" class="form-control" value="{{ get_employee.address }}">
                                    </div>
                                    <div class="mb-3">
                                        <label>Phone Number</label>
                                        <input type="text" name="phone_number" class="form-control" value="{{ get_employee.phone_number }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="id_type">ID Type</label>
                                        <select name="id_type" class="form-control">
                                            <option value="NRC" {% if get_employee.id_type == "NRC" %}selected{% endif %}>NRC</option>
                                            <option value="PASSPORT" {% if get_employee.id_type == "PASSPORT" %}selected{% endif %}>PASSPORT</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label>Identity Number</label>
                                        <input type="text" name="identity_number" class="form-control" value="{{ get_employee.identification_number }}">
                                    </div>
                                    <div class="mb-3">
                                        <label>SSN</label>
                                        <input type="text" name="ssn" class="form-control" value="{{ get_employee.ss_number }}">
                                    </div>
                                    <div class="mb-3">
                                        <label>TPIN</label>
                                        <input type="text" name="tpin" class="form-control" value="{{ get_employee.t_pin }}">
                                    </div>
                                    <div class="mb-3">
                                        <label>NHIMA Number</label>
                                        <input type="text" name="nhima_number" class="form-control" value="{{ get_employee.nhima_number }}">
                                    </div>
                                    <div class="mb-3">
                                        <label>ID Front</label>
                                        <div>
                                            <img id="previewFront" src="{{ get_employee.id_front.url }}" 
                                                 alt="ID Front" class="img-thumbnail" style="width: 150px; height: 100px; cursor: pointer;">
                                            <input type="file" name="id_front" class="form-control d-none" id="idFrontInput">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label>ID Back</label>
                                        <div>
                                            <img id="previewBack" src="{{ get_employee.id_back.url }}" 
                                                 alt="ID Back" class="img-thumbnail" style="width: 150px; height: 100px; cursor: pointer;">
                                            <input type="file" name="id_back" class="form-control d-none" id="idBackInput">
                                        </div>
                                    </div>
                                  
                                    
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div><!-- /.modal-content -->
                    </div><!-- /.modal-dialog -->
                </div><!-- /.modal -->
            </div>
        </div>
    </div>
</div>



<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-body">
                <div class="modal fade modal-xl" id="SettingsModalScrollable" tabindex="-1" aria-labelledby="SettingsModalScrollableTitle" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="SettingsModalScrollableTitle">{{ get_employee.first_name }} {{ get_employee.last_name }} - Settings</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row justify-content-center text-center">

                                    <div class="col-lg-6 mb-4">
                                        <div class="text-md-start">
                                            
                                        <h4 class="my-2">Update Password</h4>
                                        <div id="response-message" class="text-danger"></div>

                                        </div>

                                        <form id="change-password-form" method="POST" action="{% url 'base:submit_change_password' %}">
                                            {% csrf_token %}
                                            <div class="single-form">
                                                <div class="my-4" id="password-feedback" style="font-size: 14px;"></div>
                                                
                                                <input type="password" id="current_password" class="form-control" name="current_password" placeholder="Enter Your Current Password" required>
                                            </div>
                                            <div class="single-form" id="new-password-section" style="display: none;">
                                                <p>New Password</p>
                                                <input type="password" id="new_password" class="form-control" name="new_password" placeholder="********" required>
                                            </div>
                                            <div class="single-form" id="confirm-new-password-section" style="display: none;">
                                                <p>Confirm New Password</p>
                                                <input type="password" id="confirm_new_password" class="form-control" name="confirm_new_password" placeholder="********" required>
                                            </div>
                                            <div class="my-4" id="password-match-feedback" style="font-size: 14px;"></div>
                                            <button type="button" id="submitBtn" class="btn btn-primary text-md-start" disabled>Update</button>
                                        </form>
                                    </div>

                                    <div class="col-lg-6 mb-4">
                                        <form action=" {% url 'base:update_profile_pic' %}" method="POST">
                                            {% csrf_token %}
                                            <label class="form-label">Profile Picture</label>

                   6                         {% if get_employee.second_profile_picture %}
                                                <div>
                                                    <img id="previewFront2" src="{{ get_employee.second_profile_picture.url }}" 
                                                        alt="Second Profile Picture" class="img-thumbnail rounded-circle" 
                                                        style="width: 200px; height: 200px; object-fit: cover; cursor: pointer;" 
                                                        onclick="document.getElementById('idFrontInput2').click();">
                                                    <input type="file" name="profile_picture" class="form-control d-none" id="idFrontInput2" accept="image/*" onchange="previewProfilePic(event, 'previewFront2')">
                                                </div>
                                            {% else %}
                                                <div>
                                                    <img id="previewFront2" src="{% static 'assets/logo/default-profile.png' %}" 
                                                        alt="Default Profile Picture" class="img-thumbnail rounded-circle" 
                                                        style="width: 200px; height: 200px; object-fit: cover; cursor: pointer;" 
                                                        onclick="document.getElementById('idFrontInput2').click();">
                                                    <input type="file" name="profile_picture" class="form-control d-none" id="idFrontInput2" accept="image/*" onchange="previewProfilePic(event, 'previewFront2')">
                                                </div>

                                                <button type="submit" class="btn btn-primary my-5"> Save </button>
                                            {% endif %}
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary">Save changes</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for live image preview -->
<script>
    function previewProfilePic(event, previewId) {
        var file = event.target.files[0];  // Get the selected file
        if (file) {
            var reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById(previewId).src = e.target.result;
            };
            reader.readAsDataURL(file);  // Read the file as a data URL
        }
    }
</script>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function previewImage(input, previewId) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById(previewId).src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    document.getElementById('previewFront').addEventListener('click', function () {
        document.getElementById('idFrontInput').click();
    });

    document.getElementById('idFrontInput').addEventListener('change', function () {
        previewImage(this, 'previewFront');
    });

    document.getElementById('previewBack').addEventListener('click', function () {
        document.getElementById('idBackInput').click();
    });

    document.getElementById('idBackInput').addEventListener('change', function () {
        previewImage(this, 'previewBack');
    });

    console.log("Password change");



$(document).ready(function () {
    function toggleSubmitButton() {
        const isCurrentPasswordValid = $('#password-feedback').text() === 'Password is correct';
        const newPassword = $('#new_password').val().trim();
        const confirmPassword = $('#confirm_new_password').val().trim();
        const doPasswordsMatch = newPassword === confirmPassword && newPassword !== '';

        const shouldEnable = isCurrentPasswordValid && doPasswordsMatch;

        $('#submitBtn').prop('disabled', !shouldEnable);

    
        if (!doPasswordsMatch && newPassword !== '' && confirmPassword !== '') {
            $('#password-match-feedback').text('Passwords do not match').css('color', 'red');
        } else {
            $('#password-match-feedback').text('');
        }
    }

    $('#current_password').on('keyup', function () {
        var currentPassword = $(this).val();

        if (currentPassword.trim() !== '') {
            $.ajax({
                url: "{% url 'base:update_password' %}", 
                type: 'POST',
                data: {
                    'current_password': currentPassword,
                    'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function (response) {
                    if (response.status === 'success') {
                        $('#password-feedback').text('Password is correct').css('color', 'green');
                        $('#new_password').closest('.single-form').show();
                        $('#confirm_new_password').closest('.single-form').show();
                        toggleSubmitButton();
                    } else if (response.status === 'error') {
                        $('#password-feedback').text('Invalid password').css('color', 'red');
                        $('#new_password').closest('.single-form').hide();
                        $('#confirm_new_password').closest('.single-form').hide();
                        toggleSubmitButton();
                    }
                },
                error: function (xhr, status, error) {
                    $('#password-feedback').text('An error occurred').css('color', 'red');
                    $('#new_password').closest('.single-form').hide();
                    $('#confirm_new_password').closest('.single-form').hide();
                    toggleSubmitButton();
                }
            });
        } else {
            $('#password-feedback').text('');
            $('#new_password').closest('.single-form').hide();
            $('#confirm_new_password').closest('.single-form').hide();
            toggleSubmitButton();
        }
    });

    $('#new_password, #confirm_new_password').on('keyup', function () {
        toggleSubmitButton();
    });


    $('#new_password').closest('.single-form').hide();
    $('#confirm_new_password').closest('.single-form').hide();
    $('#submitBtn').prop('disabled', true);
});


$(document).ready(function () {
    $('#submitBtn').on('click', function (event) {
        event.preventDefault();  
        
        const newPassword = $('#new_password').val().trim();  
        
        $.ajax({
            url: "{% url 'base:submit_change_password' %}", 
            type: 'POST',
            data: {
                'new_password': newPassword,  
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(), 
            },
            success: function (response) {
                console.log(response.message);  
                
        
                if (response.message === 'Password updated successfully') {
                   
                    $('#password-feedback').html(
                        '<p style="font-size: 18px; font-weight: bold; color: green;">Password has been changed successfully.</p>' +
                        '<p style="font-size: 16px; color: orange;">You will be logged out shortly.</p>'
                    );
                    
                    setTimeout(function () {
                        window.location.href = '/user_logout/';  
                    }, 10000);  
                }
            },
            error: function (xhr, status, error) {
                console.log("Error:", error);  
                $('#password-feedback').text('An error occurred. Please try again.').css('color', 'red');
            }
        });
    });
});



</script>
<script src="{% static 'assets/libs/apexcharts/apexcharts.min.js' %}"></script>
<script src="{% static 'assets/js/pages/apexcharts.init.js' %}"></script>
<script src="assets/js/app.js"></script>
{% endblock %}

